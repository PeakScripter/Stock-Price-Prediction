import pandas as pd
import numpy as np
import ta

def add_technical_indicators(df):
    """
    Adds technical indicators to the dataframe.
    
    Args:
        df (pd.DataFrame): Dataframe with 'Close', 'High', 'Low', 'Volume' columns.
        
    Returns:
        pd.DataFrame: Dataframe with added technical indicators.
    """
    df = df.copy()
    
    # RSI
    df['RSI'] = ta.momentum.RSIIndicator(close=df['Close'], window=14).rsi()
    
    # MACD
    macd = ta.trend.MACD(close=df['Close'])
    df['MACD'] = macd.macd()
    df['MACD_Signal'] = macd.macd_signal()
    df['MACD_Diff'] = macd.macd_diff()
    
    # Bollinger Bands
    bollinger = ta.volatility.BollingerBands(close=df['Close'], window=20, window_dev=2)
    df['BB_High'] = bollinger.bollinger_hband()
    df['BB_Low'] = bollinger.bollinger_lband()
    df['BB_Mid'] = bollinger.bollinger_mavg()
    
    # SMA and EMA
    df['SMA_20'] = ta.trend.SMAIndicator(close=df['Close'], window=20).sma_indicator()
    df['EMA_20'] = ta.trend.EMAIndicator(close=df['Close'], window=20).ema_indicator()
    
    # Volume is typically already present, but we ensure it's used if needed
    # We can add Volume-based indicators like On-Balance Volume (OBV) if desired
    # df['OBV'] = ta.volume.OnBalanceVolumeIndicator(close=df['Close'], volume=df['Volume']).on_balance_volume()

    # Drop NaN values generated by indicators (e.g., initial SMA values)
    df.dropna(inplace=True)
    
    return df
